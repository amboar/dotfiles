#!/usr/bin/sh

set -eux

heihei_git_latest()
{
  git tag --list --contains HEAD |
    grep --invert-match ^"$(git describe --tags --always HEAD)"\$
}

# langage-managed installations
pipx upgrade-all
rustup upgrade

# chroots
schroot -c trixie -u root -- sh -c "apt -o Apt::Cmd::Disable-Script-Warning=true update && apt -o Apt::Cmd::Disable-Script-Warning=true upgrade -y"

# VMs
for M in $(virsh --readonly --connect qemu:///system list --name | head -n-1)
do
  ssh -tA "$M".local sudo sh -c "'apt update'"
  ssh -tA "$M".local sudo sh -c "'apt upgrade -y'"
done

# source installations
(
  
  cd ~/src/github.com/helix-editor/helix
  git fetch --tags origin
  helix_tag="$(heihei_git_latest || true)"
  if [ -n "$helix_tag" ]
  then
    git checkout "$helix_tag"
    cargo install --path helix-term --locked
  fi
)

(
  cd ~/src/github.com/google/bloaty/.git
  git fetch --tags origin
  bloaty_tag="$(heihei_git_latest || true)"
  if [ -n "$bloaty_tag" ]
  then
    git checkout "$bloaty_tag"
    cmake --build build
    cmake --build build --target install
  fi
)
