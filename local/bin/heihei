#!/usr/bin/sh

set -eux

: ${HEIHEI_UPDATES:="bloaty coccinelle fish flatpaks halloy helix packetry pipx rustup schroots vms wasm-pack"}

APT_OPTS="-o Apt::Cmd::Disable-Script-Warning=true"

heihei_git_latest()
{
  if [ $# -eq 1 ] && [ -n "$1" ]
  then
    echo $1
  else
    # May print nothing if current commit is ahead of most recent tag
    git tag --sort=-taggerdate --sort=-version:refname --contains $(git merge-base HEAD origin/HEAD) |
      grep -E '^v?[0-9]+[.]' |
      head -n1
  fi
}

heihei_git_changed() {
  if [ $# -eq 0 ]
  then
    return 1
  fi
  # Account for empty $1, where current commit is ahead of most recent tag
  if [ -z $1 ]
  then
    return 1
  fi
  # HEAD and $1 may name different object types, in which case we should only
  # test equivalence once they are both resolved to their corresponding commits
  [ $(git rev-parse HEAD^{commit}) != $(git rev-parse ${1}^{commit}) ]
}

# SSH authentication
if echo $HEIHEI_UPDATES | grep -q vms
then
  until gpg --card-status >/dev/null 2>&1 ; do read -p "Insert nitrokey: " V; done
fi

if echo $HEIHEI_UPDATES | grep -q pipx
then
  pipx upgrade-all
fi

if echo $HEIHEI_UPDATES | grep -q rustup
then
  rustup upgrade
fi

if echo $HEIHEI_UPDATES | grep -q flatpaks
then
  flatpak --assumeyes update
fi

if echo $HEIHEI_UPDATES | grep -q schroots
then
  for R in $(schroot --list)
  do
    schroot -c "$R" -u root -- sh -c "apt $APT_OPTS update"
    schroot -c "$R" -u root -- sh -c "apt $APT_OPTS upgrade -y"
    schroot -c "$R" -u root -- sh -c "apt $APT_OPTS autoremove -y"
  done
fi

if echo $HEIHEI_UPDATES | grep -q vms
then
  for M in $(virsh --readonly --connect qemu:///system list --name | head -n-1)
  do
    # Work-around for flaky agent auth over socket forwarding with nitrokey (?)
    until ssh -A "$M".local sudo -S sh -c "'apt $APT_OPTS update'" </dev/null; do sleep 1; done
    until ssh -A "$M".local sudo -S sh -c "'apt $APT_OPTS upgrade -y'" </dev/null; do sleep 1; done
    until ssh -A "$M".local sudo -S sh -c "'apt $APT_OPTS autoremove -y'" </dev/null; do sleep 1; done
  done
fi

if echo $HEIHEI_UPDATES | grep -q halloy
then
  (
    cd ~/src/github.com/squidowl/halloy
    git fetch --tags origin
    halloy_tag="$(heihei_git_latest ${HEIHEI_HALLOY_ID:-""})"
    if heihei_git_changed "$halloy_tag"
    then
      git checkout "$halloy_tag"
      cargo install --path . --locked
    fi
  )
fi

if echo $HEIHEI_UPDATES | grep -q helix
then
  (
    cd ~/src/github.com/helix-editor/helix
    git fetch --tags origin
    helix_tag="$(heihei_git_latest ${HEIHEI_HELIX_ID:-""})"
    if heihei_git_changed "$helix_tag"
    then
      git checkout "$helix_tag"
      cargo install --path helix-term --locked
    fi
  )
fi

if echo $HEIHEI_UPDATES | grep -q bloaty
then
  (
    cd ~/src/github.com/google/bloaty
    git fetch --tags origin
    bloaty_tag="$(heihei_git_latest ${HEIHEI_BLOATY_ID:-""})"
    if heihei_git_changed "$bloaty_tag"
    then
      git checkout "$bloaty_tag"
      git submodule update

      # BUILD_TESTING=OFF: Work around v1.1 missing `#include <cstdint>` in tests/fuzz_driver.cc
      cmake -S . -B build -D BUILD_TESTING=OFF -D CMAKE_INSTALL_PREFIX="${HOME}"/.local
      cmake --build build
      cmake --build build --target install
    fi
  )
fi

if echo $HEIHEI_UPDATES | grep -q fish
then
  (
    cd ~/src/github.com/fish-shell/fish-shell
    git fetch --tags origin
    fish_tag="$(heihei_git_latest ${HEIHEI_FISH_ID:-""})"
    if heihei_git_changed "$fish_tag"
    then
      git checkout "$fish_tag"
      cmake -DCMAKE_INSTALL_PREFIX="${HOME}"/.local -B build
      cmake --build build
      cmake --install build
    fi
  )
fi

if echo $HEIHEI_UPDATES | grep -q packetry
then
  (
    cd ~/src/github.com/greatscottgadgets/packetry
    git fetch --tags origin
    packetry_tag="$(heihei_git_latest ${HEIHEI_PACKETRY_ID:-""})"
    if heihei_git_changed "$packetry_tag"
    then
      git checkout "$packetry_tag"
      cargo install --path . --bin packetry
    fi
  )
fi

if echo $HEIHEI_UPDATES | grep -q coccinelle
then
  (
    cd ~/src/github.com/coccinelle/coccinelle
    git fetch --tags origin
    coccinelle_tag="$(heihei_git_latest ${HEIHEI_COCCINELLE_ID:-""})"
    if heihei_git_changed "$coccinelle_tag"
    then
      git checkout "$coccinelle_tag"
      ./autogen
      ./configure --prefix=${HOME}/.local --enable-ocaml --enable-python --with-python=python3 --enable-opt
      make -j$(nproc)
      make install
    fi
  )
fi

if echo $HEIHEI_UPDATES | grep -q wasm-pack
then
  (
    cd ~/src/github.com/rustwasm/wasm-pack
    git fetch --tags origin
    wasm_pack_tag="$(heihei_git_latest ${HEIHEI_WASM_PACK_ID:-""})"
    if heihei_git_changed "$wasm_pack_tag"
    then
      git checkout "$wasm_pack_tag"
      cargo install --path . --locked
    fi
  )
fi
